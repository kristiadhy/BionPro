@using Domain.Parameters
@using Web.Services.IHttpRepository

@inject DialogService DialogService
@inject IServiceManager ServiceManager

<RadzenDataGrid @ref="PurchaseDetailGrid"
                IsLoading=@GridIsLoading
                Data="@PurchaseDetails"
                TItem="PurchaseDetailDto"
                SelectionMode="DataGridSelectionMode.Single"
                AllowSorting="true"
                AllowFiltering="false"
                AllowColumnResize="true"
                AllowColumnReorder="false"
                GridLines="DataGridGridLines.Both"
                class="my-4">
    <Columns>
        <RadzenDataGridColumn Width="50px"
                              Title="#" Filterable="false"
                              Sortable="false"
                              TextAlign="TextAlign.Center">
            <Template Context="data">
                @(PurchaseDetails.IndexOf(data) + 1)
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="ProductID"
                              Visible=false
                              Filterable="false"
                              Title="ID"
                              TextAlign="TextAlign.Center">
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="ProductName"
                              Title="Product Name"
                              Frozen="true" />

        <RadzenDataGridColumn Property="Quantity"
                              Title="Qty"
                              Width="80px"
                              TextAlign="TextAlign.Center"
                              FormatString="{0:n0}">
            <FooterTemplate>
                <b>@PurchaseDetails.Sum(o => o.Quantity).ToString("n0")</b>
            </FooterTemplate>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="Price"
                              Title="Price"
                              Width="100px"
                              TextAlign="TextAlign.Right"
                              FormatString="{0:c}" />

        <RadzenDataGridColumn Property="DiscountPercentage"
                              Title="Discount"
                              Width="100px"
                              TextAlign="TextAlign.Right"
                              FormatString="{0:p2}" />

        <RadzenDataGridColumn Property="SubTotal"
                              Title="SubTotal"
                              Width="125px"
                              TextAlign="TextAlign.Right"
                              FormatString="{0:c}">
            <FooterTemplate>
                <b>@PurchaseDetails.Sum(o => o.SubTotal).ToString("C")</b>
            </FooterTemplate>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

<RadzenStack Orientation="Orientation.Horizontal"
             JustifyContent="JustifyContent.Left"
             Gap="1rem"
             Class="rz-my-4">

    <RadzenButton ButtonStyle="ButtonStyle.Light"
                  Variant="Variant.Flat"
                  Click="@((args) => DialogService.Close(false))"
                  Size="ButtonSize.Medium"
                  Icon="clear"
                  Text="Cancel" />
</RadzenStack>

@code {
    private RadzenDataGrid<PurchaseDetailDto> PurchaseDetailGrid = default!;
    private bool GridIsLoading = false;
    private List<PurchaseDetailDto> PurchaseDetails = [];
    private MetaData MetaData = new();

    [Parameter] public int? purchaseID { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if(purchaseID is not null)
        {
            await LoadData(purchaseID.Value);
        }

        await base.OnParametersSetAsync();
    }

    private async Task LoadData(int purchaseID)
    {
        PurchaseDetailParam purchaseDetailParam = new();
        var pagingResponse = await ServiceManager.PurchaseDetailService.GetPurchaseByID(purchaseID, purchaseDetailParam);
        PurchaseDetails = pagingResponse.Items;
        MetaData = pagingResponse.MetaData;
    }
}
