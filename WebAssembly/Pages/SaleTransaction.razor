@page "/sales/create"
@page "/sales/edit"
@page "/sales/edit/{ParamSaleID:int}"
@using WebAssembly.Validators

<PageTitle>@($"{ApplicationDetail?.ApplicationName} | {SalePageModel?.Title}")</PageTitle>

<MainMenuContainer>
    <MainTransactionButton OnButtonBackClicked="EvBackToPrevious" />
</MainMenuContainer>

<RadzenRow Gap="0.5rem" RowGap="0.5rem">
    <RadzenColumn SizeLG="8" SizeMD="12" class="rz-pb-5">
        <TransactionPageHeader FormStatus="@FormStatus" AdditionalText="@AdditionalHeaderText" />
        <RadzenCard class="my-2">
            <RadzenTemplateForm Context="SaleFormContext" Data="@SaleState.SaleForTransaction" Submit="@((SaleDto args) => SubmitAsync(args))">
                <FluentValidationValidator />

                <RadzenStack Gap="1rem">
                    <RadzenColumn SizeLG="12" SizeMD="12">
                        <CustomerDropdown @bind-SelectedValue="SaleState.SaleForTransaction.CustomerID" />
                    </RadzenColumn>
                    <RadzenColumn SizeLG="12" SizeMD="12">
                        <CustomDatePicker Value="@(SaleState.SaleForTransaction.Date.DateTime)"
                                          OnChange="@(args => OnDateChanged(args))"
                                          OnRefreshClick="@(args => RefreshDate())" />
                    </RadzenColumn>

                    <RadzenPanel AllowCollapse="true">
                        <HeaderTemplate>
                            <RadzenText TextStyle="TextStyle.Subtitle1" Class="rz-display-flex rz-align-items-center mb-3">
                                <RadzenIcon Icon="list" /> Sale Details
                            </RadzenText>
                        </HeaderTemplate>

                        <ChildContent>
                            <RadzenStack Gap="1rem">
                                <RadzenColumn Size="12">
                                    <RadzenSelectBar @bind-Value=@ProductSearchSelection
                                                     TValue="int"
                                                     Size="ButtonSize.ExtraSmall">
                                        <Items>
                                            <RadzenSelectBarItem Text="Enter Product Code" Value="1" />
                                            <RadzenSelectBarItem Text="Select From Product List" Value="2" />
                                        </Items>
                                    </RadzenSelectBar>
                                </RadzenColumn>

                                <RadzenTemplateForm Context="SaleDetailFormContext" Data="@SaleDetail" Submit="@((SaleDetailDto args) => AddToSaleDetailGrid(args))">
                                    <FluentValidationValidator @ref="SaleDetailValidator" />

                                    <RadzenStack Orientation="Orientation.Horizontal"
                                                 Wrap="FlexWrap.Wrap"
                                                 Gap="1rem"
                                                 AlignItems="AlignItems.Center">

                                        @if (ProductSearchSelection == 2)
                                        {
                                            <ProductDropDown @bind-SelectedValue="SaleDetail.ProductID" />
                                        }
                                        else if (ProductSearchSelection == 1)
                                        {
                                            <RadzenFormField Text="Enter Product Code" Variant="@FieldVariant">
                                                <RadzenTextBox Name="ProductCode" />
                                            </RadzenFormField>
                                        }

                                        <RadzenFormField Text="Quantity" Variant="@FieldVariant">
                                            <RadzenNumeric @bind-Value="@SaleDetail.Quantity"
                                                           TValue="int"
                                                           Format="n0"
                                                           Name="Quantity"
                                                           Placeholder="Quantity"
                                                           Step="1"
                                                           InputAttributes="@(new Dictionary<string, object> { { "aria-label", "enter value" } })"
                                                           Style="width: 150px;" />
                                        </RadzenFormField>

                                        <RadzenFormField Text="Discount" Variant="@FieldVariant">
                                            <RadzenNumeric @bind-Value="@SaleDetail.DiscountPercentage"
                                                           TValue="decimal"
                                                           Format="p2"
                                                           Name="Discount"
                                                           Placeholder="Discount"
                                                           Step="0.01"
                                                           Min="0"
                                                           Max="1"
                                                           InputAttributes="@(new Dictionary<string, object> { { "aria-label", "enter value" } })"
                                                           Style="width: 150px;" />
                                        </RadzenFormField>

                                        <RadzenButton ButtonType="ButtonType.Submit" Variant="Variant.Outlined"
                                                      Icon="add_circle_outline"
                                                      ButtonStyle="ButtonStyle.Primary"
                                                      Size="ButtonSize.Medium" />

                                    </RadzenStack>

                                    <ValidationSummary class="mt-3" />

                                </RadzenTemplateForm>

                                <RadzenDataGrid @ref="SaleDetailGrid"
                                                IsLoading=@GridIsLoading
                                                Data="@SaleState.SaleForTransaction.SaleDetails"
                                                TItem="SaleDetailDto"
                                                SelectionMode="DataGridSelectionMode.Single"
                                                AllowSorting="true"
                                                AllowFiltering="false"
                                                AllowColumnResize="true"
                                                AllowColumnReorder="false"
                                                GridLines="DataGridGridLines.Both"
                                                class="my-4">
                                    <Columns>
                                        <RadzenDataGridColumn Width="50px"
                                                              Title="#" Filterable="false"
                                                              Sortable="false"
                                                              TextAlign="TextAlign.Center">
                                            <Template Context="data">
                                                @(SaleState.SaleForTransaction.SaleDetails.IndexOf(data) + 1)
                                            </Template>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn Property="ProductID"
                                                              Visible=false
                                                              Filterable="false"
                                                              Title="ID"
                                                              TextAlign="TextAlign.Center">
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn Property="ProductName"
                                                              Title="Product Name"
                                                              Frozen="true" />

                                        <RadzenDataGridColumn Property="Quantity"
                                                              Title="Qty"
                                                              Width="80px"
                                                              TextAlign="TextAlign.Center"
                                                              FormatString="{0:n0}">
                                            <FooterTemplate>
                                                <b>@SaleState.SaleForTransaction.SaleDetails.Sum(o => o.Quantity).ToString("n0")</b>
                                            </FooterTemplate>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn Property="Price"
                                                              Title="Price"
                                                              Width="100px"
                                                              TextAlign="TextAlign.Right"
                                                              FormatString="{0:c}" />

                                        <RadzenDataGridColumn Property="DiscountPercentage"
                                                              Title="Discount"
                                                              Width="100px"
                                                              TextAlign="TextAlign.Right"
                                                              FormatString="{0:p2}" />

                                        <RadzenDataGridColumn Property="SubTotal"
                                                              Title="SubTotal"
                                                              Width="125px"
                                                              TextAlign="TextAlign.Right"
                                                              FormatString="{0:c}">
                                            <FooterTemplate>
                                                <b>@SaleState.SaleForTransaction.SaleDetails.Sum(o => o.SubTotal).ToString("C")</b>
                                            </FooterTemplate>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn Context="Action"
                                                              Title="Action"
                                                              Width="100px"
                                                              Filterable="false"
                                                              Sortable="false"
                                                              TextAlign="TextAlign.Left">

                                            <Template Context="dto">
                                                <RadzenButton Icon="edit"
                                                              ButtonStyle="ButtonStyle.Light"
                                                              Variant="Variant.Flat"
                                                              Size="ButtonSize.Medium"
                                                              Click="@(args => EvEditDetails(dto))"
                                                              @onclick:stopPropagation="true">
                                                </RadzenButton>

                                                <RadzenButton ButtonStyle="ButtonStyle.Danger"
                                                              Icon="delete"
                                                              Variant="Variant.Flat"
                                                              Shade="Shade.Lighter"
                                                              Size="ButtonSize.Medium"
                                                              class="my-1 ms-1"
                                                              Click="@(args => EvDeleteRow(dto))"
                                                              @onclick:stopPropagation="true">
                                                </RadzenButton>
                                            </Template>
                                        </RadzenDataGridColumn>
                                    </Columns>
                                </RadzenDataGrid>
                            </RadzenStack>
                        </ChildContent>
                    </RadzenPanel>

                    <RadzenTextArea Name="@nameof(SaleState.SaleForTransaction.Description)"
                                    Placeholder="Description"
                                    class="w-100"
                                    aria-label="TextArea"
                                    @bind-Value="SaleState.SaleForTransaction.Description" />

                </RadzenStack>

                <ValidationSummary />

                <SaveTransactionButton OnButtonClear="ClearField"
                                       IsBusy="@IsSaving" />

            </RadzenTemplateForm>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>