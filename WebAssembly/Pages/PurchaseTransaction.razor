@page "/purchases/create"
@page "/purchases/edit"
@page "/purchases/edit/{ParamPurchaseID:int}"
@using WebAssembly.Validators

<PageTitle>@($"{GlobalConstant.AppName} | {PurchasePageModel?.Title}")</PageTitle>

<MainMenuContainer>
    <MainTransactionButton OnButtonBackClicked="EvBackToPrevious" />
</MainMenuContainer>

<RadzenRow Gap="0.5rem" RowGap="0.5rem">
    <RadzenColumn SizeLG="8" SizeMD="12" class="rz-pb-5">
        <RadzenCard class="my-2">
            <RadzenTemplateForm Context="PurchaseFormContext" Data="@PurchaseState.Purchase" Submit="@((PurchaseDto args) => SubmitAsync(args))">
                <FluentValidationValidator />

                <RadzenFieldset Text="@FormHeaderText">
                    <RadzenStack Gap="1rem">
                        <RadzenColumn SizeLG="12" SizeMD="12">
                            <SupplierDropdown SelectedValue="PurchaseState.Purchase.SupplierID"
                                              SelectedValueChanged="OnSupplierChanged" />
                        </RadzenColumn>
                        <RadzenColumn SizeLG="12" SizeMD="12">
                            <CustomDatePicker Value="@(PurchaseState.Purchase.Date.DateTime)"
                                              OnChange="@(args => OnDateChanged(args))"
                                              OnRefreshClick="@(args => RefreshDate())" />
                        </RadzenColumn>

                        <RadzenPanel AllowCollapse="true">
                            <HeaderTemplate>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Class="rz-display-flex rz-align-items-center mb-3">
                                    <RadzenIcon Icon="list" /> Purchase Details
                                </RadzenText>
                            </HeaderTemplate>

                            <ChildContent>
                                <RadzenStack Gap="1rem">
                                    <RadzenColumn Size="12">
                                        <RadzenSelectBar @bind-Value=@ProductSearchSelection
                                                         TValue="int"
                                                         Size="ButtonSize.ExtraSmall">
                                            <Items>
                                                <RadzenSelectBarItem Text="Enter Product Code" Value="1" />
                                                <RadzenSelectBarItem Text="Select From Product List" Value="2" />
                                            </Items>
                                        </RadzenSelectBar>
                                    </RadzenColumn>

                                    <RadzenTemplateForm Context="PurchaseDetailFormContext" Data="@PurchaseDetail" Submit="@((PurchaseDetailDto args) => AddToPurchaseDetailGrid(args))">
                                        <FluentValidationValidator @ref="PurchaseDetailValidator" />

                                        <RadzenStack Orientation="Orientation.Horizontal"
                                                     Wrap="FlexWrap.Wrap"
                                                     Gap="1rem"
                                                     AlignItems="AlignItems.Center">

                                            @if (ProductSearchSelection == 2)
                                            {
                                                <ProductDropDown @bind-SelectedValue="PurchaseDetail.ProductID" />
                                            }
                                            else if (ProductSearchSelection == 1)
                                            {
                                                <RadzenFormField Text="Enter Product Code" Variant="@FieldVariant">
                                                    <RadzenTextBox Name="ProductCode" />
                                                </RadzenFormField>
                                            }

                                            <RadzenFormField Text="Quantity" Variant="@FieldVariant">
                                                <RadzenNumeric @bind-Value="@PurchaseDetail.Quantity"
                                                               TValue="int"
                                                               Format="n0"
                                                               Name="Quantity"
                                                               Placeholder="Quantity"
                                                               Step="1"
                                                               InputAttributes="@(new Dictionary<string, object> { { "aria-label", "enter value" } })"
                                                               Style="width: 150px;" />
                                            </RadzenFormField>

                                            <RadzenFormField Text="Discount" Variant="@FieldVariant">
                                                <RadzenNumeric @bind-Value="@PurchaseDetail.DiscountPercentage"
                                                               TValue="decimal"
                                                               Format="p2"
                                                               Name="Discount"
                                                               Placeholder="Discount"
                                                               Step="0.01"
                                                               Min="0"
                                                               Max="1"
                                                               InputAttributes="@(new Dictionary<string, object> { { "aria-label", "enter value" } })"
                                                               Style="width: 150px;" />
                                            </RadzenFormField>

                                            <RadzenButton ButtonType="ButtonType.Submit" Variant="Variant.Outlined"
                                                          Icon="add_circle_outline"
                                                          ButtonStyle="ButtonStyle.Primary"
                                                          Size="ButtonSize.Medium" />

                                        </RadzenStack>

                                        <ValidationSummary class="mt-3" />

                                    </RadzenTemplateForm>

                                    <RadzenDataGrid @ref="PurchaseDetailGrid"
                                                    IsLoading=@GridIsLoading
                                                    Data="@PurchaseState.Purchase.PurchaseDetails"
                                                    TItem="PurchaseDetailDto"
                                                    SelectionMode="DataGridSelectionMode.Single"
                                                    AllowSorting="true"
                                                    AllowFiltering="false"
                                                    AllowColumnResize="true"
                                                    AllowColumnReorder="false"
                                                    GridLines="DataGridGridLines.Both"
                                                    class="my-4">
                                        <Columns>
                                            <RadzenDataGridColumn Width="50px"
                                                                  Title="#" Filterable="false"
                                                                  Sortable="false"
                                                                  TextAlign="TextAlign.Center">
                                                <Template Context="data">
                                                    @(PurchaseState.Purchase.PurchaseDetails.IndexOf(data) + 1)
                                                </Template>
                                            </RadzenDataGridColumn>

                                            <RadzenDataGridColumn Property="ProductID"
                                                                  Visible=false
                                                                  Filterable="false"
                                                                  Title="ID"
                                                                  TextAlign="TextAlign.Center">
                                            </RadzenDataGridColumn>

                                            <RadzenDataGridColumn Property="ProductName"
                                                                  Title="Product Name"
                                                                  Frozen="true" />

                                            <RadzenDataGridColumn Property="Quantity"
                                                                  Title="Qty"
                                                                  Width="80px"
                                                                  FormatString="{0:n0}" />

                                            <RadzenDataGridColumn Property="Price"
                                                                  Title="Price"
                                                                  Width="100px"
                                                                  FormatString="{0:c}" />

                                            <RadzenDataGridColumn Property="DiscountPercentage"
                                                                  Title="Discount"
                                                                  Width="100px"
                                                                  FormatString="{0:p2}" />

                                            <RadzenDataGridColumn Property="SubTotal"
                                                                  Title="SubTotal"
                                                                  Width="100px"
                                                                  FormatString="{0:c}" />

                                            <RadzenDataGridColumn Context="Action"
                                                                  Title="Action"
                                                                  Width="100px"
                                                                  Filterable="false"
                                                                  Sortable="false"
                                                                  TextAlign="TextAlign.Left">

                                                <Template Context="dto">
                                                    <RadzenButton Icon="edit"
                                                                  ButtonStyle="ButtonStyle.Light"
                                                                  Variant="Variant.Flat"
                                                                  Size="ButtonSize.Medium"
                                                                  Click="@(args => EvEditDetails(dto))"
                                                                  @onclick:stopPropagation="true">
                                                    </RadzenButton>

                                                    <RadzenButton ButtonStyle="ButtonStyle.Danger"
                                                                  Icon="delete"
                                                                  Variant="Variant.Flat"
                                                                  Shade="Shade.Lighter"
                                                                  Size="ButtonSize.Medium"
                                                                  class="my-1 ms-1"
                                                                  Click="@(args => EvDeleteRow(dto))"
                                                                  @onclick:stopPropagation="true">
                                                    </RadzenButton>
                                                </Template>
                                            </RadzenDataGridColumn>
                                        </Columns>
                                    </RadzenDataGrid>
                                </RadzenStack>
                            </ChildContent>
                        </RadzenPanel>

                        <RadzenTextArea Name="@nameof(PurchaseState.Purchase.Description)"
                                        Placeholder="Description"
                                        class="w-100"
                                        aria-label="TextArea"
                                        @bind-Value="PurchaseState.Purchase.Description" />

                    </RadzenStack>
                </RadzenFieldset>

                <ValidationSummary />

                <SaveTransactionButton OnButtonClear="ClearField"
                                       IsBusy="@IsSaving" />

            </RadzenTemplateForm>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>