@page "/purchases/create"
@page "/purchases/edit"
@page "/purchases/edit/{ParamPurchaseID:int}"

<PageTitle>@($"{GlobalState.AppName} | {PurchasePageModel?.Title}")</PageTitle>

<MainMenuContainer>
    <MainTransactionButton OnButtonBackClicked="EvBackToPrevious" />
</MainMenuContainer>

<RadzenRow Gap="0.5rem" RowGap="0.5rem">
    <RadzenColumn SizeLG="8" SizeMD="12" class="rz-pb-5">
        <RadzenCard class="my-2">
            <RadzenTemplateForm Data="@PurchaseState.Purchase" Submit="@(async (PurchaseDto args) => { await SubmitAsync(args); })">
                <FluentValidationValidator @ref="PurchaseValidator" />

                <RadzenFieldset Text="@FormHeaderText">
                    <RadzenStack Gap="1rem">
                        <RadzenColumn SizeLG="12" SizeMD="12">
                            <SupplierDropdown SelectedValue="PurchaseState.Purchase.SupplierID"
                                              SelectedValueChanged="OnSupplierChanged" />
                        </RadzenColumn>
                        <RadzenColumn SizeLG="12" SizeMD="12">
                            <CustomDatePicker Value="@(PurchaseState.Purchase.Date.DateTime)"
                                              OnChange="@(args => OnDateChanged(args))"
                                              OnRefreshClick="@(args => RefreshDate())" />
                        </RadzenColumn>

                        <RadzenPanel AllowCollapse="true">
                            <HeaderTemplate>
                                <RadzenText TextStyle="TextStyle.Subtitle1" Class="rz-display-flex rz-align-items-center mb-3">
                                    <RadzenIcon Icon="list" /> Purchase Details
                                </RadzenText>
                            </HeaderTemplate>

                            <ChildContent>
                                <RadzenStack Gap="1rem">
                                    <RadzenColumn Size="12">
                                        <RadzenSelectBar @bind-Value=@ProductSearchSelection
                                                         TValue="int"
                                                         Size="ButtonSize.ExtraSmall">
                                            <Items>
                                                <RadzenSelectBarItem Text="Enter Product Code" Value="1" />
                                                <RadzenSelectBarItem Text="Select From Product List" Value="2" />
                                            </Items>
                                        </RadzenSelectBar>
                                    </RadzenColumn>

                                    <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap">

                                        @if (ProductSearchSelection == 2)
                                        {
                                            @*                                             <ProductDropDown SelectedValue="PurchaseState.PurchaseDetailForTransaction.ProductID"
                                        SelectedValueChanged="OnProductChanged" /> *@
                                            <RadzenAutoComplete @bind-Value=@PurchaseState.PurchaseDetailForTransaction.ProductName
                                                                Data=@ProductState.ProductListDropdown
                                                                TextProperty="@nameof(ProductDto.Name)"
                                                                Style="width: 13rem"
                                                                InputAttributes="@(new Dictionary<string,object>(){ { "aria-label", "Product Name" }})" />
                                        }
                                        else if (ProductSearchSelection == 1)
                                        {
                                            <RadzenFormField Text="Enter Product Code" Variant="@FieldVariant">
                                                <RadzenTextBox Name="ProductCode" />
                                            </RadzenFormField>
                                        }

                                        <RadzenFormField Text="Quantity" Variant="@FieldVariant">
                                            <RadzenNumeric @bind-Value="@PurchaseState.PurchaseDetailForTransaction.Quantity"
                                                           TValue="int"
                                                           Format="n0"
                                                           Name="Quantity"
                                                           Placeholder="Quantity"
                                                           Step="1"
                                                           InputAttributes="@(new Dictionary<string, object> { { "aria-label", "enter value" } })"
                                                           Style="width: 150px;" />
                                        </RadzenFormField>

                                        <RadzenFormField Text="Discount" Variant="@FieldVariant">
                                            <RadzenNumeric @bind-Value="@PurchaseState.PurchaseDetailForTransaction.DiscountPercentage"
                                                           TValue="decimal"
                                                           Format="p2"
                                                           Name="Discount"
                                                           Placeholder="Discount"
                                                           Step="0.01"
                                                           Min="0"
                                                           Max="1"
                                                           InputAttributes="@(new Dictionary<string, object> { { "aria-label", "enter value" } })"
                                                           Style="width: 150px;" />
                                        </RadzenFormField>

                                    </RadzenStack>

                                    <RadzenDataGrid @ref="PurchaseDetailGrid"
                                                    IsLoading=@GridIsLoading
                                                    Data="@PurchaseState.PurchaseDetailListForTransaction"
                                                    TItem="PurchaseDetailDto"
                                                    SelectionMode="DataGridSelectionMode.Single"
                                                    AllowSorting="true"
                                                    AllowFiltering="false"
                                                    AllowColumnResize="true"
                                                    AllowColumnReorder="false"
                                                    GridLines="DataGridGridLines.Both"
                                                    ColumnWidth="150px"
                                                    class="my-4">
                                        <Columns>
                                            <RadzenDataGridColumn Width="50px"
                                                                  Title="#" Filterable="false"
                                                                  Sortable="false"
                                                                  TextAlign="TextAlign.Center">
                                                <Template Context="data">
                                                    @(PurchaseState.PurchaseDetailListForTransaction.IndexOf(data) + 1)
                                                </Template>
                                            </RadzenDataGridColumn>

                                            <RadzenDataGridColumn Property="ProductID"
                                                                  Visible=false
                                                                  Filterable="false"
                                                                  Title="ID"
                                                                  TextAlign="TextAlign.Center">
                                            </RadzenDataGridColumn>

                                            <RadzenDataGridColumn Property="ProductName"
                                                                  Title="Product"
                                                                  Frozen="true" />

                                            <RadzenDataGridColumn Property="Quantity"
                                                                  Title="Qty" Width="80px"
                                                                  FormatString="{0:n0}" />

                                            <RadzenDataGridColumn Property="Price"
                                                                  Title="Price"
                                                                  FormatString="{0:c}" />

                                            <RadzenDataGridColumn Property="Discount"
                                                                  Title="Discount"
                                                                  FormatString="{0:p2}" />

                                            <RadzenDataGridColumn Property="SubTotal"
                                                                  Title="SubTotal"
                                                                  FormatString="{0:c}" />

                                            <RadzenDataGridColumn Context="Action"
                                                                  Title="Action"
                                                                  Filterable="false"
                                                                  Sortable="false"
                                                                  TextAlign="TextAlign.Left">

                                                <Template Context="dto">
                                                    <RadzenButton Icon="edit"
                                                                  ButtonStyle="ButtonStyle.Light"
                                                                  Variant="Variant.Flat"
                                                                  Size="ButtonSize.Medium"
                                                                  Click="@(args => EvEditQty(dto))"
                                                                  @onclick:stopPropagation="true">
                                                    </RadzenButton>

                                                    <RadzenButton ButtonStyle="ButtonStyle.Danger"
                                                                  Icon="delete"
                                                                  Variant="Variant.Flat"
                                                                  Shade="Shade.Lighter"
                                                                  Size="ButtonSize.Medium"
                                                                  class="my-1 ms-1"
                                                                  Click="@(args => EvDeleteRow(dto))"
                                                                  @onclick:stopPropagation="true">
                                                    </RadzenButton>
                                                </Template>
                                            </RadzenDataGridColumn>
                                        </Columns>
                                    </RadzenDataGrid>
                                </RadzenStack>
                            </ChildContent>
                        </RadzenPanel>

                        <RadzenTextArea Name="@nameof(PurchaseState.Purchase.Description)"
                                        Placeholder="Description"
                                        class="w-100"
                                        aria-label="TextArea"
                                        @bind-Value="PurchaseState.Purchase.Description" />

                    </RadzenStack>
                </RadzenFieldset>
                <ValidationSummary />

                <SaveTransactionButton OnButtonClear="ClearField"
                                       IsBusy="@IsSaving" />

            </RadzenTemplateForm>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>